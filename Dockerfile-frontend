### 1) Node ビルドステージ
FROM node:20 AS builder
WORKDIR /app
COPY . .

# ★ Cloud Build の Build 環境変数を受け取る
ARG VITE_SUPABASE_URL
ARG VITE_SUPABASE_ANON_KEY

# ★ npm run build が  import.meta.env を解決できるよう ENV にも書き戻す
ENV VITE_SUPABASE_URL=$VITE_SUPABASE_URL
ENV VITE_SUPABASE_ANON_KEY=$VITE_SUPABASE_ANON_KEY

RUN npm ci
RUN npm run build          # ← ここで Vite が値を注入

### 2) 配信用ステージ
FROM nginx:stable-alpine
COPY --from=builder /app/dist /usr/share/nginx/html
EXPOSE 8080

